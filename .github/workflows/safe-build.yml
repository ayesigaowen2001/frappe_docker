name: Optimized ERPNext Multi-Arch Builder

on:
  workflow_dispatch:
    inputs:
      version:
        description: "ERPNext version (v15, v14, develop)"
        required: true
        default: "v15"
      python_version:
        description: "Python version"
        required: true
        default: "3.10"
      node_version:
        description: "Node.js version"
        required: true
        default: "18"
      push_to_dockerhub:
        description: "Push images to Docker Hub?"
        type: boolean
        required: true
        default: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            base:
              - 'images/base/**'
            build:
              - 'images/build/**'

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        if: ${{ github.event.inputs.push_to_dockerhub == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Export build variables
        run: |
          echo "PYTHON_VERSION=${{ github.event.inputs.python_version }}" >> $GITHUB_ENV
          echo "NODE_VERSION=${{ github.event.inputs.node_version }}" >> $GITHUB_ENV
          echo "FRAPPE_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "ERPNEXT_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "REGISTRY_USER=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_ENV

      - name: Build with Bake
        uses: docker/bake-action@v6
        with:
          files: docker-bake.hcl
          push: ${{ github.event.inputs.push_to_dockerhub }}
          targets: >
            bench,
            erpnext
            ${{ steps.changes.outputs.base == 'true' && ',base' || '' }}
            ${{ steps.changes.outputs.build == 'true' && ',build' || '' }}

      - name: Summary
        run: |
          echo "ðŸ’š BUILD COMPLETE"
          echo "Built ERPNext version: ${{ github.event.inputs.version }}"
          echo "Python: ${{ github.event.inputs.python_version }}"
          echo "Node: ${{ github.event.inputs.node_version }}"
          echo ""
          echo "Rebuild Summary:"
          echo "Base image rebuilt: ${{ steps.changes.outputs.base }}"
          echo "Build image rebuilt: ${{ steps.changes.outputs.build }}"
          echo "Bench image rebuilt: always"
          echo "ERPNext image rebuilt: always"
